<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.13.3 (455969)"/><meta name="author" content="羊锡贵"/><meta name="created" content="2017-11-18 01:15:32 +0000"/><meta name="source" content="desktop.win"/><meta name="source-application" content="evernote.win32"/><meta name="source-url" content="https://ninghao.net/blog/2834"/><meta name="updated" content="2017-11-18 06:34:16 +0000"/><title>Node下的token验证</title></head><body><div><div><font style="font-size: 11pt;"><span style="line-height: 1.45;"><b>实施流程</b></span><br/></font></div><div><font style="font-size: 11pt;"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span> 1、客户端使用用户名、密码登录</font></div><div><font style="font-size: 11pt;"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span> 2、服务器端验证用户名和密码，然后生成一个token响应给客户端</font></div><div><font style="font-size: 11pt;"><span>&nbsp;&nbsp;&nbsp;&nbsp; </span>3、客户端将获取的token保存起来，以后需要资源时需要传送token给服务器，服务器根据请求的token是否为自己的token，从而来决定是否响应请求。</font></div><div><font style="font-size: 11pt;"><br/></font></div><div><span style="line-height: 21px;"><b><font style="font-size: 11pt;">token的内容即生成</font></b></span></div><div><font style="font-size: 11pt;"><span style="line-height: 21px;">&nbsp;&nbsp;&nbsp;&nbsp;token由header、payload、signature组成。 </span><span style="line-height: 21px;">header包含了类型typ，使用算法alg，如</span></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="line-height: 21px;"><font style="font-size: 11pt;"><span style="font-family: Monaco; color: rgb(51, 51, 51);">{</span></font></span></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="line-height: 21px;"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"typ"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"JWT"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">,</span></span></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"alg"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"HS256"</span></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="font-family: Monaco; color: rgb(51, 51, 51);">}</span></div></div><div><font style="font-size: 11pt;"><span style="line-height: 21px;">&nbsp;&nbsp; base64编码后如</span><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="border: 1px solid rgba(0, 0, 0, 0.14902); line-height: 1.5; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word; background-color: rgb(40, 44, 52); overflow-x: auto; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><font style="color: rgb(214, 214, 214); font-size: 11pt;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</font></span></div></div><div><font style="font-size: 11pt;"><br/></font></div><div><font style="font-size: 11pt;"><span style="line-height: 21px;">&nbsp;&nbsp;payload包含的字段如下</span><br/></font></div><div><span style="line-height: 21px;"><span><font style="font-size: 11pt;"><br/></font></span></span></div><font style="font-size: 11pt;"><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>iss：Issuer，发行者</span><br/><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>sub：Subject，主题</span><br/><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>aud：Audience，观众</span><br/><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>exp：Expiration time，过期时间</span><br/><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>nbf：Not before</span><br/><span style="font-family: PingFangSC-Light, sans-serif; line-height: 1.7; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>iat：Issued at，发行时间</span><br/><span style="line-height: 1.7; font-family: PingFangSC-Light, sans-serif; background-color: rgb(248, 248, 248); color: rgb(51, 51, 51); orphans: 2; widows: 2;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span>jti：JWT ID</span><br/></font><div><font style="font-size: 11pt;"><br/></font></div><div><font style="font-size: 11pt;">如<br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">{</font></span></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"iss"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"<a href="http://ninghao.net/">ninghao.net</a>"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">,</span></font></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"exp"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"1438955445"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">,</span></font></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"name"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"wanghao"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">,</span></font></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;"><span style="color: rgb(209, 154, 102); font-family: Monaco;"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>"admin"</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">:</span> <span style="color: rgb(86, 182, 194); font-family: Monaco;">true</span></font></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="font-family: Monaco; color: rgb(51, 51, 51);"><font style="font-size: 11pt;">}</font></span></div></div><div><font style="font-size: 11pt;"><br/></font></div><div><font style="font-size: 11pt;">base64编码后</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="border: 1px solid rgba(0, 0, 0, 0.14902); line-height: 1.5; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(171, 178, 191); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word; background-color: rgb(40, 44, 52); overflow-x: auto; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;"><font style="font-size: 11pt;">eyJpc3MiOiJuaW5naGFvLm5ldCIsImV4cCI6IjE0Mzg5NTU0NDUiLCJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlfQ</font></span></div></div><div><font style="font-size: 11pt;"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span>&nbsp;&nbsp;<span style="line-height: 21px;">signature参数由header和payload组成，先将header和payload编码然后再加密，如</span></span></span><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span><font style="font-size: 11pt;"><span style="color: rgb(198, 120, 221); font-family: Monaco;">var</span> <span style="font-family: Monaco; color: rgb(51, 51, 51);">encodedString = base64UrlEncode(header) +</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">"."</span> <span style="font-family: Monaco; color: rgb(51, 51, 51);">+ base64UrlEncode(payload);</span></font></span></div><div style="font-family: Monaco; color: rgb(51, 51, 51);"><span style="font-family: Monaco; color: rgb(51, 51, 51);">HMACSHA256(encodedString,</span> <span style="color: rgb(152, 195, 121); font-family: Monaco;">'secret'</span><span style="font-family: Monaco; color: rgb(51, 51, 51);">);</span></div></div><div><font style="font-size: 11pt;"><br/></font></div><div><font style="font-size: 11pt;">最终token如下</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><font style="font-size: 11pt;"><span style="border: 1px solid rgba(0, 0, 0, 0.14902); line-height: 1.5; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(224, 108, 117); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word; background-color: rgb(40, 44, 52); overflow-x: auto; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><span style="border: 1px solid rgba(0, 0, 0, 0.14902); line-height: 1.5; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(209, 154, 102); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word; background-color: rgb(40, 44, 52); overflow-x: auto; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">.eyJpc3MiOiJuaW5naGFvLm5ldCIsImV4cCI6IjE0Mzg5NTU0NDUiLCJuYW1lIjoid2FuZ2hhbyIsImFkbWluIjp0cnVlfQ</span><span style="border: 1px solid rgba(0, 0, 0, 0.14902); line-height: 1.5; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; color: rgb(209, 154, 102); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; white-space: pre-wrap; word-break: break-all; word-wrap: break-word; background-color: rgb(40, 44, 52); overflow-x: auto; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-position: initial initial; background-repeat: initial initial;">.SwyHTEx_RQppr97g4J5lKXtabJecpejuef8AqKYMAJc</span></font></div></div><div><font style="font-size: 11pt;"><br/></font></div><div><font style="font-size: 11pt;"><b>node下使用token</b></font></div><div><font style="font-size: 11pt;">安装npm块jwt-simple，如</font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;">cnpm install jwt-simple --save</div><div><span style="font-size: 15px; line-height: 21px;">获取token码</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">jwt.</span><span style="color: #a6e22e; font-family: Monaco; font-size: 9pt;">encode</span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">({</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>iss</span><span style="color: #f92672; font-family: Monaco; font-size: 9pt;">:</span> <span style="color: #e6db74; font-family: Monaco; font-size: 9pt;">'user_1'</span><span style="color: #cc7832; font-family: Monaco; font-size: 9pt;">,</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>exp</span><span style="color: #f92672; font-family: Monaco; font-size: 9pt;">:</span> <span style="color: #e6db74; font-family: Monaco; font-size: 9pt;">'1438955445'</span></div><div style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span><span style="color: #cc7832; font-family: Monaco; font-size: 9pt;">,</span> <span style="color: #e6db74; font-family: Monaco; font-size: 9pt;">'19931018'</span><span style="color: #cc7832; font-family: Monaco; font-size: 9pt;">,</span><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">)</span><span style="color: #cc7832; font-family: Monaco; font-size: 9pt;">;</span></div></div><div><span style="font-size: 15px; line-height: 21px;">其中encode参数为payload，key，algorithm，options</span></div><div><span style="font-size: 15px; line-height: 21px;">生成的token码如下</span></div><div><span style="font-size: 15px; line-height: 21px;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902); background-position: initial initial; background-repeat: initial initial;-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJ1c2VyXzEiLCJleHAiOiIxNDM4OTU1NDQ1In0.w7FIwh_EUQBJffSGozh4jyAEU5rR3l6RZPPLVjDEhmY</span></div></div><div><br/></div><div><span style="font-size: 15px; line-height: 21px;">参考文档</span></div><div><span style="font-size: 15px; line-height: 21px;"><a href="https://ninghao.net/blog/2834">《基于Token的身份验证》</a></span></div><div><span style="font-size: 15px; line-height: 21px;"><a href="https://www.sitepoint.com/using-json-web-tokens-node-js/">《Using JSON Web Tokens with Node.js》</a></span></div></div></body></html>